on:
  push:
    branches:
      - main
jobs:
  build-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Setup Node Environment
        uses: actions/setup-node@v3
      - name: Setup Go Environment
        uses: actions/setup-go@v3
        with:
          go-version: '1.19'
      - name: Install Dependencies
        run: yarn install
      - name: Compile Project
        run: yarn build
      - name: Update Build Date and Version
        run: |
          sed -i "s/%TODAY%/$(date +%Y-%m-%d)/" dist/plugin.json
          sed -i "s/%VERSION%/$(grep -m1 -oe '[0-9\.]\+' < CHANGELOG.md)/" dist/plugin.json
      - name: Compatibility Check
        run: npx --yes @grafana/levitate@latest is-compatible --path src/module.tsx --target @grafana/data,@grafana/ui,@grafana/runtime
      - name: Package Project
        run: |
          mv dist ventura-rawdata-panel
          zip ventura-rawdata-panel.zip ventura-rawdata-panel -r
          md5sum ventura-rawdata-panel.zip > ventura-rawdata-panel.md5
      - name: Validate Plugin
        run: |
          git clone https://github.com/grafana/plugin-validator
          pushd ./plugin-validator/pkg/cmd/plugincheck2
          go install
          popd
          plugincheck2 -config ./plugin-validator/config/default.yaml ventura-rawdata-panel.zip
      - name: Create Github release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            ventura-rawdata-panel.zip
            ventura-rawdata-panel.md5